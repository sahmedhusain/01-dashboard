# ============================================================================
# AUDIT BASIC QUERIES
# Core audit queries for peer reviews and audit system
# ============================================================================

# Get audit by ID
query GetAuditById($auditId: Int!) {
  audit(where: { id: { _eq: $auditId } }) {
    id
    grade
    createdAt
    updatedAt
    attrs
    version
    endAt
    private
    # Auditor information
    auditor {
      id
      login
      firstName
      lastName
      campus
      totalUp
      totalDown
    }
    # Group being audited
    group {
      id
      status
      path
      campus
      createdAt
      updatedAt
      # Group captain
      captain {
        id
        login
        firstName
        lastName
      }
      # Group members
      users {
        confirmed
        createdAt
        user {
          id
          login
          firstName
          lastName
        }
      }
      # Object/project the group is working on
      object {
        id
        name
        type
        attrs
      }
      # Event context
      event {
        id
        path
        campus
      }
    }
    # Result of the audit
    result {
      id
      grade
      type
      createdAt
      updatedAt
      attrs
      version
      isLast
    }
  }
}

# Get audits by auditor
query GetAuditsByAuditor($auditorLogin: String!, $limit: Int = 50, $offset: Int = 0) {
  audit(
    where: { auditor: { login: { _eq: $auditorLogin } } }
    order_by: { createdAt: desc }
    limit: $limit
    offset: $offset
  ) {
    id
    grade
    createdAt
    updatedAt
    attrs
    version
    endAt
    private
    # Group being audited
    group {
      id
      status
      path
      campus
      # Object/project the group is working on
      object {
        id
        name
        type
        attrs
      }
    }
    # Result of the audit
    result {
      id
      grade
      type
      isLast
    }
  }
}

# Get audits for a group
query GetAuditsForGroup($groupId: Int!, $limit: Int = 20) {
  audit(
    where: { groupId: { _eq: $groupId } }
    order_by: { createdAt: desc }
    limit: $limit
  ) {
    id
    grade
    createdAt
    updatedAt
    attrs
    version
    endAt
    private
    # Auditor information
    auditor {
      id
      login
      firstName
      lastName
      campus
    }
    # Result of the audit
    result {
      id
      grade
      type
      createdAt
      isLast
    }
  }
}

# Get pending audits (no result yet)
query GetPendingAudits($limit: Int = 50) {
  audit(
    where: { resultId: { _is_null: true } }
    order_by: { createdAt: desc }
    limit: $limit
  ) {
    id
    grade
    createdAt
    updatedAt
    attrs
    version
    endAt
    # Auditor information
    auditor {
      id
      login
      firstName
      lastName
      campus
    }
    # Group being audited
    group {
      id
      status
      path
      campus

      # Object/project the group is working on
      object {
        id
        name
        type
        attrs
      }
    }
  }
}

# Get completed audits (with results)
query GetCompletedAudits($limit: Int = 50, $offset: Int = 0) {
  audit(
    where: { resultId: { _is_null: false } }
    order_by: { createdAt: desc }
    limit: $limit
    offset: $offset
  ) {
    id
    grade
    createdAt
    updatedAt
    attrs
    version
    # Auditor information
    auditor {
      id
      login
      firstName
      lastName
      campus
    }
    # Group being audited
    group {
      id
      status
      path
      campus

      # Object/project the group is working on
      object {
        id
        name
        type
        attrs
      }
    }
    # Result of the audit
    result {
      id
      grade
      type
      createdAt
      updatedAt
      attrs
      version
      isLast
    }
  }
}

# Get audits by grade range
query GetAuditsByGradeRange($minGrade: numeric!, $maxGrade: numeric!, $limit: Int = 50) {
  audit(
    where: { 
      grade: { _gte: $minGrade, _lte: $maxGrade }
    }
    order_by: { grade: desc }
    limit: $limit
  ) {
    id
    grade
    createdAt
    updatedAt
    attrs
    version
    # Auditor information
    auditor {
      id
      login
      firstName
      lastName
      campus
    }
    # Group being audited
    group {
      id
      status
      path
      campus
      # Object/project the group is working on
      object {
        id
        name
        type
        attrs
      }
    }
    # Result of the audit
    result {
      id
      grade
      type
      isLast
    }
  }
}

# Get audits by campus
query GetAuditsByCampus($campus: String!, $limit: Int = 100, $offset: Int = 0) {
  audit(
    where: { 
      _or: [
        { auditor: { campus: { _eq: $campus } } }
        { group: { campus: { _eq: $campus } } }
      ]
    }
    order_by: { createdAt: desc }
    limit: $limit
    offset: $offset
  ) {
    id
    grade
    createdAt
    updatedAt
    attrs
    version
    # Auditor information
    auditor {
      id
      login
      firstName
      lastName
      campus
    }
    # Group being audited
    group {
      id
      status
      path
      campus
      # Object/project the group is working on
      object {
        id
        name
        type
        attrs
      }
    }
    # Result of the audit
    result {
      id
      grade
      type
      isLast
    }
  }
}

# Get audits by date range
query GetAuditsByDateRange($startDate: timestamptz!, $endDate: timestamptz!, $limit: Int = 100) {
  audit(
    where: { 
      createdAt: { _gte: $startDate, _lte: $endDate }
    }
    order_by: { createdAt: desc }
    limit: $limit
  ) {
    id
    grade
    createdAt
    updatedAt
    attrs
    version
    # Auditor information
    auditor {
      id
      login
      firstName
      lastName
      campus
    }
    # Group being audited
    group {
      id
      status
      path
      campus
      # Object/project the group is working on
      object {
        id
        name
        type
        attrs
      }
    }
    # Result of the audit
    result {
      id
      grade
      type
      isLast
    }
  }
}

# Get expired audits
query GetExpiredAudits($currentTime: timestamptz!, $limit: Int = 50) {
  audit(
    where: { 
      endAt: { _lt: $currentTime }
      resultId: { _is_null: true }
    }
    order_by: { endAt: desc }
    limit: $limit
  ) {
    id
    grade
    createdAt
    updatedAt
    endAt
    attrs
    version
    # Auditor information
    auditor {
      id
      login
      firstName
      lastName
      campus
    }
    # Group being audited
    group {
      id
      status
      path
      campus
      # Object/project the group is working on
      object {
        id
        name
        type
        attrs
      }
    }
  }
}
